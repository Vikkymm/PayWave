{% extends "base.html" %}
{% block content %}
<h2>Admin Panel</h2>

<div class="row g-3">
  <div class="col-md-4">
    <div class="card p-3 shadow-sm">
      <h6>Overview</h6>
      <div class="small text-muted">
        Users: {{ totals.users }} • Trades: {{ totals.trades }} • Pending Trades: {{ totals.pending_trades }}
      </div>
      <a class="btn btn-primary btn-sm mt-2" href="/">View site</a>
    </div>

    <div class="card p-3 shadow-sm mt-3">
      <h6>Rates & Tags</h6>
      <form method="post">
        {% for r in rates %}
        <div class="mb-2">
          <label class="small">{{ r['method'] }}</label>
          <input class="form-control form-control-sm mb-1" name="rate_{{ r['id'] }}" value="{{ r['rate_ngn_per_usd'] }}">
          <input class="form-control form-control-sm mb-1" name="tag_{{ r['id'] }}" value="{{ r['tag'] }}">
          <select class="form-select form-select-sm" name="status_{{ r['id'] }}">
            <option value="active" {% if r['status']=='active' %}selected{% endif %}>Active</option>
            <option value="locked" {% if r['status']=='locked' %}selected{% endif %}>Locked</option>
          </select>
        </div>
        {% endfor %}
        <button class="btn btn-primary btn-sm">Save</button>
      </form>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card p-3 shadow-sm mb-3">
      <h6>Users</h6>
      <table class="table">
        <thead><tr><th>Email</th><th>Balance (₦)</th></tr></thead>
        <tbody>
          {% for u in users %}
          <tr><td>{{ u['email'] }}</td><td>₦{{ '%.2f'|format(u['balance_ngn']) }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ✅ Deposits with Proof -->
    <div class="card p-3 shadow-sm mb-3">
      <h6>Deposits</h6>
      <table class="table">
        <thead>
          <tr>
            <th>User</th><th>Method</th><th>USD</th><th>₦</th><th>Tag</th><th>Proof</th><th>Status</th><th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for t in trades %}
          <tr>
            <td>{{ t['user_email'] }}</td>
            <td>{{ t['method'] }}</td>
            <td>${{ '%.2f'|format(t['amount_usd']) }}</td>
            <td>₦{{ '%.2f'|format(t['amount_ngn']) }}</td>
            <td>
              {% set tag = ((rates|selectattr('method','equalto',t['method'])|list)[0]['tag']) %}
              <div class="small text-muted">{{ tag }}</div>
            </td>

            <!-- ✅ Show proof if exists -->
            <td>
              {% if t['proof'] %}
                <a href="{{ url_for('uploaded_file', filename=t['proof']) }}" target="_blank" class="btn btn-sm btn-outline-primary">View Proof</a>
              {% else %}
                <span class="text-muted small">No proof</span>
              {% endif %}
            </td>

            <td>{{ t['status'] }}</td>
            <td>
              {% if t['status']=='Pending' %}
                <a class="btn btn-sm btn-success" href="/approve_trade/{{ t['id'] }}">Approve</a>
                <a class="btn btn-sm btn-danger" href="/reject_trade/{{ t['id'] }}">Reject</a>
              {% else %}
                <span class="small text-muted">Processed</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="8" class="text-muted">No deposits</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card p-3 shadow-sm">
      <h6>Withdrawals</h6>
      <table class="table">
        <thead><tr><th>User</th><th>Name</th><th>Bank</th><th>Account</th><th>Amount (₦)</th><th>Status</th><th>Action</th></tr></thead>
        <tbody>
          {% for w in withdrawals %}
          <tr>
            <td>{{ w['user_email'] }}</td>
            <td>{{ w['name'] }}</td>
            <td>{{ w['bank'] }}</td>
            <td>{{ w['account'] }}</td>
            <td>₦{{ '%.2f'|format(w['amount_ngn']) }}</td>
            <td>{{ w['status'] }}</td>
            <td>
              {% if w['status']=='Pending' %}
              <a class="btn btn-sm btn-success" href="/approve_withdraw/{{ w['id'] }}">Approve</a>
              <a class="btn btn-sm btn-danger" href="/reject_withdraw/{{ w['id'] }}">Reject</a>
              {% else %}
              <span class="small text-muted">Processed</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="text-muted">No withdrawals</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
